---
title: "Vue ã® reactivity ã‚’ä½¿ã£ãŸ tanstack/vue-query v5 ã®åˆ¶å¾¡æ–¹æ³•æ¤œè¨ã®ãŸã‚ã«ã€å®Ÿè£…ãƒ»æ–‡æ›¸ãƒ»PRã‚’æ¼ã‚‹"
---

`@tanstack/vue-query` v4 ã‚’ä½¿ã£ã¦ WebAPI ã‚’å‘¼ã³å‡ºã™ hook ã‚’å®Ÿè£…ã—ã¦ã„ãŸã¨ãã€ WebAPI ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼(`paramRef`)ã®çŠ¶æ…‹ (string or undefined) ã«å¿œã˜ã¦ `enabled` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ API ã®å‘¼ã³å‡ºã—ã‚’åˆ¶å¾¡ã—ã¦ã„ãŸã€‚

åˆ‡ã‚Šæ›¿ãˆãŸã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ `enabled` ã ã‘ã ã‘ã‚Œã©ã€`queryKey` ã¨ `queryFn` ã‚‚ `paramRef` ã«ä¾å­˜ã—ã¦ã„ã‚‹ (undefined ã®ã¨ãã¯å®Ÿè¡Œã•ã›ãŸããªã„ã—ã€å‹ã‚‚ä¸æ­£)ã€‚
ãã®ãŸã‚ã€useQuery ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¸¸ã”ã¨ computed ã—ã¦ã„ãŸã€‚

```ts
export const useApi = (paramRef: Ref<string | undefined>) => {
  return useQuery(
    computed(() => {
      const param = paramRef.value;
      return !param
        ? { enabled: false }
        : {
            queryKey: createQueryKey(param),
            queryFn: () => callApi(param),
          };
    }),
  );
};
```

`@tanstack/vue-query` v5 ã«æ›´æ–°ã—ãŸã¨ã“ã‚ã€å‹ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã‚ˆã†ã«ãªã£ã¦ã—ã¾ã£ãŸã€‚è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã€`createQueryKey(param)` ã¨åŒã˜ã€ã¾ãŸã¯ã‚µãƒ–ã‚»ãƒƒãƒˆã®å‹ã‚’å®šç¾©ã™ã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚

```ts
export const useApi = (paramRef: Ref<string | undefined>) => {
  return useQuery(
    computed(() => {
      const param = paramRef.value;
      return !param
        ? {
            enabled: false,
            queryKey: ["key", "__DUMMY__"] as const, // ğŸ‘ˆ ???!!!!
          }
        : {
            queryKey: createQueryKey(param), // ã“ã‚Œã®å‹ãŒ readonly ["key", string]
            queryFn: () => callApi(param),
          };
    }),
  );
};
```

**ã¾ãã€å«Œã ...ã€‚** ä½¿ã„æ–¹ãŒé–“é•ã£ã¦ã„ã‚‹ã¯ãšã ã—ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç­‰ã‚’èª­ã‚“ã§ã¿ã‚‹ã€‚

---

https://tanstack.com/query/latest/docs/framework/vue/reference/useQuery

> `enabled: boolean | (query: Query) => boolean`
>
> - Set this to false to disable this query from automatically running.
> - Can be used for Dependent Queries.

`enabled` ã«é–¢æ•°ã‚’æ¸¡ã™ã“ã¨ã§ã€ callback ã§ `query` ã‚’å—ã‘å–ã£ã¦ true/false ã‚’æ±ºã‚ã‚‰ã‚Œãã†ã€ã£ã¦æ€ã£ãŸã‘ã‚Œã©ã€setup æ™‚ã« query ãŒ undefined ã«ãªã‚‹ã€‚

query ãŒå‹ã«åã—ã¦ undefined ã«ãªã‚‹ã®ã¯ã€vue-query ãŒ query ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å¼•æ•°ã§æ¸¡ã—ã¦ã„ãªã„ã‹ã‚‰ã€‚

https://github.com/TanStack/query/blob/v5.55.4/packages/vue-query/src/useBaseQuery.ts#L90

Issue ã‚‚å‡ºæ¥ã¦ã„ãŸã€‚
vue-query ã® lifecycle çš„ã« setup æ™‚ã« query instance ã‚’å–å¾—ã™ã‚‹ã®ã¯å³ã—ãã†ã€‚å‹ã®å•é¡Œã‚‚ã‚ã‚‹ã‚‰ã—ã„ (`as any` ä½¿ã£ã¦ã‚‹ãã‚‰ã„ã ã—ãª...)

[[vue-query] Callback for enabled does not provide query as parameter #7905](https://github.com/TanStack/query/issues/7905)

ãŸã ã—ã€`enabled` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«é–¢æ•°ã‚’æ¸¡ã™ã®ã¯æ­£ã—ã„ã£ã½ã„ã€‚`'should be enabled to accept getter function'` ã£ã¦ã„ã†ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚‚ã‚ã‚‹ã€‚

https://github.com/TanStack/query/blob/v5.55.4/packages/vue-query/src/__tests__/useQuery.test.ts#L271

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®åˆ¥ã®è¨˜è¿°ã ã¨ã€`enabled` ã«ã¯ computedRef ã‚’æ¸¡ã—ã¦ã„ã‚‹ã€‚

https://tanstack.com/query/v5/docs/framework/vue/guides/disabling-queries#lazy-queries

ã¨ã‚Šã‚ãˆãšåˆ†ã‹ã£ãŸã®ã¯ã€**vue-query ã® api reference ã¯å½“ã¦ã«ãªã‚‰ãªã„**ã£ã½ã„ã“ã¨...ã€‚Vue ã¨ React ã ã¨ API ã‚‚ å†…éƒ¨ã®å®Ÿè£…ã‚‚çµæ§‹é•ã†ã®ã« API Document ãŒå…±é€šã«ãªã£ã¦ã„ã‚‹ã€‚

https://github.com/TanStack/query/blob/main/docs/framework/vue/reference/useQuery.md

---

`enabled` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ˜ã£ã¦ã¿ã‚‹ã¨ã€çµæ§‹ã‚„ã‚„ã“ã—ã„çŠ¶æ³ã«ãªã£ã¦ã„ã‚‹ã€‚

[Add possibility to pass a callback to enabled. #7566](https://github.com/TanStack/query/pull/7566) ã§ã® query-**core** ã«å¯¾ã™ã‚‹ä¿®æ­£ã§ `enabled` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒé–¢æ•°ã‚’å—ã‘ä»˜ã‘ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚
ã“ã‚Œã¯ [v5.48.0 ã§ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ã„ã‚‹](https://github.com/TanStack/query/releases/tag/v5.48.0)
ä¸€æ–¹ã€ vue-query ã¯ v5.**47**.0 ã®æ™‚ç‚¹ã§æ—¢ã« [enabled ã«é–¢æ•°ã‚’æ¸¡ã›ã‚‹](https://github.com/TanStack/query/blob/v5.47.0/packages/vue-query/src/useBaseQuery.ts#L89)ã‚ˆã†ã«ãªã£ã¦ã„ãŸã€‚

[feat(vue-query): let composables accepts enabled as a getter function #6018](https://github.com/TanStack/query/pull/6018) ã§ computed ã ã‘ã§ãªã **getter** ãŒå—ã‘å–ã‚Œã‚‹ã‚ˆã†ã«ä¿®æ­£ã•ã‚Œã¦ã„ã‚‹ã€‚

> ```ts
> // Before
> useQuery({
>   queryKey: ["TODO"],
>   queryFn: () => Promise.resolve({ data: [] }),
>   enabled: computed(() => isMounted.value && isAuth.value),
> });
> // After
> useQuery({
>   queryKey: ["TODO"],
>   queryFn: () => Promise.resolve({ data: [] }),
>   enabled: () => isMounted.value && isAuth.value,
> });
> ```

ã¤ã¾ã‚Šã€`enabled` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ package æ¯ã«ã¾ã£ãŸãåˆ¥ã®ã‚‚ã®ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹...ã€‚

- query-core (ã¾ãŸã¯ react-query) ã«ãŠã‘ã‚‹ query ã‚’å¼•æ•°ã«ã—ãŸ callback
- vue-query ã«ãŠã‘ã‚‹ Vue getter

Vue getter ã¯ä¸€èˆ¬çš„ãª getter/setter ã¨ã¯ç•°ãªã‚‹æ¦‚å¿µã¿ãŸã„ã ã€‚ã“ã‚Œã¯åˆ¥ã®æ©Ÿä¼šã«èª¿ã¹ã‚ˆã† (https://blog.vuejs.org/posts/vue-3-3#better-getter-support-with-toref-and-tovalue)

---

## çµå±€ã©ã†ã™ã‚“ã®

### `paramRef` ã«ä¾å­˜ã—ã¦ã„ã‚‹ queryKey å•é¡Œ

`queryKey` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ `MaybeRef` å‹ãªã®ã§ã€`Ref<string | undefined>` ã®ã¾ã¾æ¸¡ã—ã¡ã‚ƒã†

### `paramRef` ã«ä¾å­˜ã—ã¦ã„ã‚‹ queryFn å•é¡Œ

skipToken ãŒä¾¿åˆ©ãã†

https://tanstack.com/query/v5/docs/framework/vue/guides/disabling-queries#typesafe-disabling-of-queries-using-skiptoken

```ts
export const useApi = (paramRef: Ref<string | undefined>) => {
  return useQuery({
    queryKey: createQueryKey(paramRef),
    queryFn: computed(() => {
      const param = paramRef.value;
      if (!param) {
        return skipToken; // ğŸ‘ˆ `enabled` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ä»£ã‚ã‚Šã« `skipToken` ã‚’è¿”ã—ã¦ disable ã«ã™ã‚‹
      }
      return () => callApi(param); // ğŸ‘ˆ param ãŒ string ãªã‚‰ API ã‚’å®Ÿè¡Œã™ã‚‹
    }),
  });
};
```
